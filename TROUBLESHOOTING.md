# Troubleshooting Guide

Common issues and solutions for RN Visual Testing.

## Installation Issues

### Yarn PnP Issues

If you encounter module resolution errors with Yarn PnP:

```bash
# Add to .yarnrc.yml in your project
nodeLinker: node-modules

# Reinstall
rm -rf node_modules .yarn/cache
yarn install
```

### Sharp Installation Fails

Sharp requires native dependencies. If installation fails:

```bash
# On macOS with ARM (M1/M2)
brew install vips

# Reinstall
yarn install --force
```

## Runtime Issues

### Simulator Not Found

**Error:** `Simulator not found: iPhone 15 Pro`

**Solution:**
1. List available simulators:
```bash
xcrun simctl list devices
```

2. Update `.rn-visual-testing.json` with exact device name:
```json
{
  "simulator": {
    "device": "iPhone 15 Pro",  // Must match exactly
    "os": "iOS 17.0"
  }
}
```

### App Won't Launch

**Error:** `Failed to launch app: com.example.app`

**Solutions:**

1. Verify bundle ID is correct:
```bash
# Check installed apps on simulator
xcrun simctl listapps booted | grep -i yourapp
```

2. Build and install app first:
```bash
# For Expo
npx expo prebuild
npx expo run:ios

# For bare React Native
yarn ios
```

3. Verify app scheme in config:
```json
{
  "simulator": {
    "appScheme": "your-app-scheme",  // From app.json or Info.plist
    "bundleId": "com.example.yourapp"  // From app.json
  }
}
```

### Storybook Connection Timeout

**Error:** `Storybook connection timeout`

**Solutions:**

1. Verify Storybook port:
```bash
# Check if Storybook is running
lsof -i :7007
```

2. Ensure Storybook is configured correctly:
```typescript
// .storybook/index.tsx
import { getStorybookUI } from '@storybook/react-native'

const StorybookUI = getStorybookUI({
  port: 7007,  // Must match config
  host: 'localhost',
})

export default StorybookUI
```

3. Check app is showing Storybook:
```typescript
// index.js
const RootComponent = __DEV__ && process.env.STORYBOOK_ENABLED
  ? StorybookUI
  : App
```

4. Launch app with Storybook enabled:
```bash
STORYBOOK_ENABLED=true yarn ios
```

### No Stories Found

**Error:** `Found 0 stories`

**Solutions:**

1. Check stories pattern in config:
```json
{
  "storybook": {
    "storiesPattern": "src/**/__stories__/**/*.stories.?(ts|tsx|js|jsx)"
  }
}
```

2. Verify stories are registered:
```typescript
// .storybook/storybook.requires.ts
// Should be auto-generated by Storybook
```

3. Ensure WebSocket is enabled in Storybook config

### Screenshot Capture Fails

**Error:** `Failed to capture screenshot`

**Solutions:**

1. Verify simulator is booted:
```bash
xcrun simctl list devices | grep Booted
```

2. Check disk space:
```bash
df -h
```

3. Try capturing manually:
```bash
xcrun simctl io booted screenshot test.png
```

### Image Comparison Errors

**Error:** `Image dimensions don't match`

**Solution:**
This means the baseline was created with a different simulator size. Either:

1. Use the same simulator device for baselines and comparisons
2. Regenerate baselines with current simulator
3. Delete mismatched baselines and create new ones

**Error:** `Baseline not found`

**Solution:**
First run with new stories needs baseline creation:

```bash
# Capture screenshots
yarn visual:capture

# Copy to baselines
mkdir -p .visual-baselines/ios/iPhone15Pro
cp .visual-screenshots/$(git branch --show-current)/* .visual-baselines/ios/iPhone15Pro/

# Commit baselines
git add .visual-baselines
git commit -m "chore: add visual baselines"
```

## Performance Issues

### Slow Screenshot Capture

**Causes:**
- Simulator performance
- Complex stories with animations
- Network requests in stories

**Solutions:**

1. Use faster simulator (newer device model)
2. Mock network requests in stories
3. Disable animations:
```typescript
// In your story decorators
import { Platform, UIManager } from 'react-native'

if (Platform.OS === 'android' && UIManager.setLayoutAnimationEnabledExperimental) {
  UIManager.setLayoutAnimationEnabledExperimental(false)
}
```

4. Increase render timeout in config:
```json
{
  "storybook": {
    "renderTimeout": 10000
  }
}
```

### Slow Image Comparison

**Solution:** Install ODiff for faster comparisons:

```bash
# macOS
brew install odiff

# Or via npm
npm install -g odiff-bin
```

## Git Issues

### Baseline Conflicts

When merging branches with different baselines:

1. Accept incoming baselines for new components
2. Keep your baselines for modified components
3. Run comparison to verify
4. Re-approve if needed

### Large Baseline Files

Screenshots can be large. Consider:

1. Using Git LFS:
```bash
git lfs install
git lfs track "*.png"
```

2. Compressing baselines:
```bash
# Use lower quality PNG compression
# (requires modifying screenshot capture)
```

## CI/CD Issues

### GitHub Actions Timeout

**Error:** Job exceeds maximum execution time

**Solutions:**

1. Split into multiple jobs
2. Use caching for dependencies
3. Use prebuilt simulators
4. Run only on changed stories

### Simulator Boot Fails in CI

**Solution:** Use pre-booted simulators:

```yaml
- name: Pre-boot simulator
  run: |
    UDID=$(xcrun simctl list devices available iPhone | grep -m 1 iPhone | sed 's/.*(\(.*\)).*/\1/')
    xcrun simctl boot $UDID

- name: Run visual tests
  run: yarn visual:capture --skip-boot --skip-shutdown
```

## Configuration Issues

### Config Not Found

**Error:** `No .rn-visual-testing.json found`

**Solution:**
Run init in project root:
```bash
rn-visual-test init
```

### Invalid Config

**Error:** `Failed to parse .rn-visual-testing.json`

**Solution:**
Validate JSON syntax:
```bash
cat .rn-visual-testing.json | python -m json.tool
```

## Debug Mode

Enable debug logging:

```bash
DEBUG=* rn-visual-test capture
```

Or in code:
```bash
export DEBUG=1
rn-visual-test capture
```

## Getting More Help

1. Check [GitHub Issues](https://github.com/yourusername/rn-visual-testing/issues)
2. Review [Documentation](README.md)
3. Open a new issue with:
   - Error message
   - System info (OS, Node version)
   - Config file
   - Steps to reproduce

## Common Workflow Issues

### First-Time Setup

Complete workflow for new project:

```bash
# 1. Install
yarn add -D @rn-visual-testing/cli

# 2. Initialize
yarn rn-visual-test init

# 3. Update config with your app settings
vim .rn-visual-testing.json

# 4. Build app
yarn ios

# 5. Capture first screenshots
yarn rn-visual-test capture

# 6. Create baselines
mkdir -p .visual-baselines/ios/iPhone15Pro
cp .visual-screenshots/main/* .visual-baselines/ios/iPhone15Pro/
git add .visual-baselines
git commit -m "chore: add visual baselines"

# 7. Make changes and test
# ... make UI changes ...
yarn rn-visual-test capture
yarn rn-visual-test compare

# 8. View report
open .visual-screenshots/$(git branch --show-current)/report.html
```

### Updating Baselines

After approving changes:

```bash
# Copy new screenshots to baselines
cp .visual-screenshots/$(git branch --show-current)/* .visual-baselines/ios/iPhone15Pro/

# Commit
git add .visual-baselines
git commit -m "chore: update visual baselines"
```
